<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ Supabase Storage</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 {
      color: #667eea;
      margin-top: 0;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      border-left: 4px solid #667eea;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ddd;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    button:hover {
      background: #5568d3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    pre {
      background: #282c34;
      color: #abb2bf;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 12px;
    }
    .image-preview {
      max-width: 200px;
      max-height: 200px;
      margin: 10px 0;
      border-radius: 5px;
      border: 2px solid #667eea;
    }
    .test-result {
      display: none;
      margin-top: 10px;
    }
    .test-result.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Supabase Storage</h1>
    
    <div class="section">
      <h3>üìù ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase</h3>
      <input type="text" id="supabaseUrl" placeholder="Supabase URL (https://xxxxx.supabase.co)">
      <input type="text" id="supabaseKey" placeholder="Supabase Anon Key">
      <button onclick="initSupabase()">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase</button>
      <div id="initStatus" class="test-result"></div>
    </div>

    <div class="section">
      <h3>üîê ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
      <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
      <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
      <button onclick="signIn()" id="signInBtn" disabled>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <div id="authStatus" class="test-result"></div>
    </div>

    <div class="section">
      <h3>üì§ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</h3>
      <input type="file" id="fileInput" accept="image/*" onchange="previewImage()" disabled>
      <div id="imagePreview"></div>
      <button onclick="testUpload()" id="uploadBtn" disabled>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
      <div id="uploadStatus" class="test-result"></div>
    </div>

    <div class="section">
      <h3>üîç ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Buckets</h3>
      <button onclick="checkBuckets()" id="checkBtn" disabled>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Storage Buckets</button>
      <div id="bucketStatus" class="test-result"></div>
    </div>

    <div class="section">
      <h3>üìä Log</h3>
      <pre id="logOutput">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</pre>
    </div>
  </div>

  <script>
    let supabase = null;
    let currentUser = null;
    const logs = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('th-TH');
      logs.push(`[${timestamp}] ${message}`);
      document.getElementById('logOutput').textContent = logs.join('\n');
      console.log(message);
    }

    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.className = `status ${type} test-result show`;
      element.textContent = message;
    }

    function initSupabase() {
      const url = document.getElementById('supabaseUrl').value.trim();
      const key = document.getElementById('supabaseKey').value.trim();

      if (!url || !key) {
        showStatus('initStatus', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Supabase URL ‡πÅ‡∏•‡∏∞ Anon Key', 'error');
        return;
      }

      try {
        supabase = window.supabase.createClient(url, key);
        log('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        showStatus('initStatus', '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        
        // Enable other buttons
        document.getElementById('signInBtn').disabled = false;
        document.getElementById('checkBtn').disabled = false;
      } catch (error) {
        log('‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
        showStatus('initStatus', '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
      }
    }

    async function signIn() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!email || !password) {
        showStatus('authStatus', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error');
        return;
      }

      try {
        log('üîê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...');
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) throw error;

        currentUser = data.user;
        log('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + currentUser.email);
        showStatus('authStatus', '‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + currentUser.email, 'success');
        
        // Enable upload
        document.getElementById('fileInput').disabled = false;
        document.getElementById('uploadBtn').disabled = false;

      } catch (error) {
        log('‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
        showStatus('authStatus', '‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
      }
    }

    function previewImage() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('imagePreview').innerHTML = 
            `<img src="${e.target.result}" class="image-preview" alt="Preview">`;
          log(`üì∑ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
        };
        reader.readAsDataURL(file);
      }
    }

    async function testUpload() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        showStatus('uploadStatus', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå', 'error');
        return;
      }

      if (!currentUser) {
        showStatus('uploadStatus', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô', 'error');
        return;
      }

      log('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...');
      showStatus('uploadStatus', '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...', 'info');

      const buckets = ['avatars', 'business-cards', 'logos'];
      const timestamp = Date.now();
      const fileExtension = file.name.split('.').pop();
      const fileName = `test-${currentUser.id}-${timestamp}.${fileExtension}`;
      const filePath = `profiles/${fileName}`;

      for (const bucket of buckets) {
        try {
          log(`ü™£ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö bucket: ${bucket}`);

          const { data, error } = await supabase.storage
            .from(bucket)
            .upload(filePath, file, {
              cacheControl: '3600',
              upsert: true
            });

          if (error) {
            log(`‚ùå Bucket "${bucket}" ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
            continue;
          }

          // Get public URL
          const { data: urlData } = supabase.storage
            .from(bucket)
            .getPublicUrl(filePath);

          log(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏õ‡∏ó‡∏µ‡πà bucket: ${bucket}`);
          log(`üîó URL: ${urlData.publicUrl}`);
          
          showStatus('uploadStatus', 
            `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\nBucket: ${bucket}\nURL: ${urlData.publicUrl}`, 
            'success'
          );

          // Show uploaded image
          document.getElementById('imagePreview').innerHTML += 
            `<div><h4>‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡∏à‡∏≤‡∏Å Storage):</h4><img src="${urlData.publicUrl}" class="image-preview" alt="Uploaded"></div>`;

          return; // Success, stop trying other buckets
        } catch (error) {
          log(`‚ùå Error with bucket "${bucket}": ${error.message}`);
        }
      }

      // All buckets failed
      log('‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏∏‡∏Å bucket');
      showStatus('uploadStatus', '‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏∏‡∏Å bucket\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Storage', 'error');
    }

    async function checkBuckets() {
      if (!supabase) {
        showStatus('bucketStatus', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏Å‡πà‡∏≠‡∏ô', 'error');
        return;
      }

      log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö buckets...');
      showStatus('bucketStatus', '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...', 'info');

      try {
        const { data: buckets, error } = await supabase.storage.listBuckets();

        if (error) throw error;

        log(`üìä ‡∏û‡∏ö ${buckets.length} buckets`);
        
        const requiredBuckets = ['avatars', 'business-cards', 'logos'];
        const foundBuckets = buckets.map(b => b.id);
        const missingBuckets = requiredBuckets.filter(b => !foundBuckets.includes(b));

        let statusMessage = `‡∏û‡∏ö ${buckets.length} buckets:\n\n`;
        statusMessage += buckets.map(b => 
          `‚úÖ ${b.id} (${b.public ? 'public' : 'private'})`
        ).join('\n');

        if (missingBuckets.length > 0) {
          statusMessage += `\n\n‚ö†Ô∏è ‡∏Ç‡∏≤‡∏î buckets:\n${missingBuckets.map(b => `‚ùå ${b}`).join('\n')}`;
          statusMessage += '\n\nüí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏±‡∏ô migration ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á buckets';
          showStatus('bucketStatus', statusMessage, 'warning');
        } else {
          statusMessage += '\n\n‚úÖ Storage ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!';
          showStatus('bucketStatus', statusMessage, 'success');
        }

        buckets.forEach(b => {
          log(`  - ${b.id} (${b.public ? 'public' : 'private'})`);
        });

      } catch (error) {
        log('‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö buckets ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
        showStatus('bucketStatus', '‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
      }
    }

    // Initial log
    log('üíª ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
    log('üìù ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Supabase URL ‡πÅ‡∏•‡∏∞ Anon Key');
  </script>
</body>
</html>

